
SET SQL DIALECT 3; 

/* CREATE DATABASE 'ping.fdb' PAGE_SIZE 8192 DEFAULT CHARACTER SET ISO8859_1; */


/*  Generators or sequences */
CREATE GENERATOR CATEGORIE;
CREATE GENERATOR INSCRIPTION;
CREATE GENERATOR JOUEUR;
CREATE GENERATOR SEEK_GEN_ID;
CREATE GENERATOR SEQ_1;
CREATE GENERATOR SEQ_2;
CREATE GENERATOR SEQ_SERGRP;
CREATE GENERATOR TOURNOI;

COMMIT WORK;

/* Table: CATAGE, Owner: SYSDBA */
CREATE TABLE CATAGE (CATAGE VARCHAR(3) NOT NULL,
        SAISON SMALLINT NOT NULL,
        INFERIEUR SMALLINT,
        SUPERIEUR SMALLINT,
        NUMSEQ SMALLINT NOT NULL,
PRIMARY KEY (CATAGE, SAISON));

/* Table: CATEGORIES, Owner: SYSDBA */
CREATE TABLE CATEGORIES (SERCAT INTEGER NOT NULL,
        SERTRN INTEGER NOT NULL,
        SAISON SMALLINT NOT NULL,
        CODCAT VARCHAR(20) NOT NULL,
        HEUDEB CHAR(5) NOT NULL,
        SIMPLE CHAR(1) NOT NULL,
        HANDICAP CHAR(1) NOT NULL,
        NUMSET SMALLINT NOT NULL,
        CATAGE CHAR(1) NOT NULL,
        STACAT CHAR(1) NOT NULL,
        NUMSEQ SMALLINT,
        FIRST_ROUND_MODE SMALLINT,
        PHASE CHAR(1) DEFAULT '0' NOT NULL,
        PARENT INTEGER DEFAULT 0 NOT NULL,
PRIMARY KEY (SERCAT));

/* Table: CLASSEMENT, Owner: SYSDBA */
CREATE TABLE CLASSEMENT (CODCLS VARCHAR(3) NOT NULL,
        LIBCLS VARCHAR(20) NOT NULL,
        NUMSEQ SMALLINT NOT NULL,
        CATAGE CHAR(1),
        SELCLS VARCHAR(3) NOT NULL,
PRIMARY KEY (CODCLS));

/* Table: CLASSEMENTS, Owner: SYSDBA */
CREATE TABLE CLASSEMENTS (SERCAT INTEGER NOT NULL,
        CODCLS VARCHAR(3) NOT NULL,
        SERTRN INTEGER NOT NULL,
PRIMARY KEY (SERCAT, CODCLS));

/* Table: CLUB, Owner: SYSDBA */
CREATE TABLE CLUB (CODCLB VARCHAR(3) NOT NULL,
        LIBCLB VARCHAR(30) NOT NULL,
PRIMARY KEY (CODCLB));

/* Table: COMPO_GROUPE, Owner: SYSDBA */
CREATE TABLE COMPO_GROUPE (SERGRP INTEGER NOT NULL,
        NUMSEQ SMALLINT NOT NULL,
        SERJOU INTEGER,
        SERCAT INTEGER NOT NULL,
        SERTRN INTEGER NOT NULL,
CONSTRAINT PK_COMPO_GROUPE PRIMARY KEY (SERGRP, NUMSEQ));

/* Table: DEFVALUES, Owner: SYSDBA */
CREATE TABLE DEFVALUES (TABLENAME VARCHAR(25) NOT NULL,
        COLNAME VARCHAR(25) NOT NULL,
        DEFVALUE VARCHAR(25),
PRIMARY KEY (TABLENAME, COLNAME));

/* Table: DICTIONNAIRE, Owner: SYSDBA */
CREATE TABLE DICTIONNAIRE (CLEDIC VARCHAR(30) NOT NULL,
        CODDIC VARCHAR(30) NOT NULL,
        LIBDIC VARCHAR(40),
        PARDC1 VARCHAR(30),
        PARDC2 VARCHAR(30),
        PARDC3 VARCHAR(30),
        PARDC4 VARCHAR(30),
        PARDC5 VARCHAR(30),
        PARDC6 VARCHAR(30),
        PARDC7 VARCHAR(30),
        PARDC8 VARCHAR(30),
        PARDC9 VARCHAR(30),
CONSTRAINT PK_DICTIONNAIRE PRIMARY KEY (CLEDIC, CODDIC));

/* Table: DOUBLONS, Owner: SYSDBA */
CREATE TABLE DOUBLONS (LICENCE VARCHAR(13) NOT NULL,
        SERJO1 INTEGER,
        SERJO2 INTEGER,
        TABLO VARCHAR(20) NOT NULL,
PRIMARY KEY (LICENCE, TABLO));

/* Table: GROUPE, Owner: SYSDBA */
CREATE TABLE GROUPE (SERGRP INTEGER NOT NULL,
        SERCAT INTEGER NOT NULL,
        NUMGRP SMALLINT NOT NULL,
        STAGRP CHAR(1) DEFAULT '0' NOT NULL,
        SERTRN INTEGER NOT NULL,
        HEURE VARCHAR(5),
        WINNER INTEGER,
        UMPIRE INTEGER,
CONSTRAINT PK_GROUPE PRIMARY KEY (SERGRP));

/* Table: GROUPE_RESULT, Owner: SYSDBA */
CREATE TABLE GROUPE_RESULT (SERGRP INTEGER NOT NULL,
        SERJOU INTEGER NOT NULL,
        SERADV INTEGER,
        WINNER SMALLINT NOT NULL,
        GAMES SMALLINT NOT NULL,
        POINTS SMALLINT NOT NULL,
        SERCAT INTEGER NOT NULL,
        SERTRN INTEGER NOT NULL);

/* Table: HANDICAP, Owner: SYSDBA */
CREATE TABLE HANDICAP (CL1 VARCHAR(3) NOT NULL,
        CL2 VARCHAR(3) NOT NULL,
        HDC SMALLINT NOT NULL,
PRIMARY KEY (CL1, CL2));

/* Table: INSC, Owner: SYSDBA */
CREATE TABLE INSC (SERINSC INTEGER NOT NULL,
        SERCAT INTEGER NOT NULL,
        DATINSC CHAR(16) NOT NULL,
        SIMPLE CHAR(1) NOT NULL,
        SERJOU INTEGER NOT NULL,
        SERPTN INTEGER,
        STATUT CHAR(1) NOT NULL,
        SERTRN INTEGER NOT NULL,
PRIMARY KEY (SERINSC));

/* Table: JOUEUR, Owner: SYSDBA */
CREATE TABLE JOUEUR (SERJOU INTEGER NOT NULL,
        SAISON SMALLINT NOT NULL,
        LICENCE VARCHAR(8) NOT NULL,
        CODCLB VARCHAR(3) NOT NULL,
        NOMJOU VARCHAR(40) NOT NULL,
        CODCLS VARCHAR(3) NOT NULL,
        TOPCLS VARCHAR(3) NOT NULL,
        TOPDEM VARCHAR(3) NOT NULL,
        DATANN DATE,
        CATAGE VARCHAR(3),
        VRBRGL SMALLINT NOT NULL,
PRIMARY KEY (SERJOU));

/* Table: MATCH, Owner: SYSDBA */
CREATE TABLE MATCH (SERMTC INTEGER NOT NULL,
        SERTAB INTEGER NOT NULL,
        LEVEL SMALLINT NOT NULL,
        NUMSEQ INTEGER NOT NULL,
        NUMMTC VARCHAR(6) NOT NULL,
        DATMTC DATE,
        HEURE VARCHAR(5),
        SERJO1 INTEGER,
        SERJO2 INTEGER,
        HANDI1 SMALLINT,
        HANDI2 SMALLINT,
        SCORE VARCHAR(3),
        VAINQUEUR INTEGER,
        PERDANT INTEGER,
        NUMTBL VARCHAR(3),
        PROCHAIN VARCHAR(8),
        STAMTC CHAR(1) NOT NULL,
        SERTRN INTEGER NOT NULL,
        GAMES VARCHAR(60),
        WOJ1 CHAR(1) DEFAULT 0,
        WOJ2 CHAR(1) DEFAULT 0,
        MODIFIE TIMESTAMP,
PRIMARY KEY (SERMTC));

/* Table: MATCH_GROUPE, Owner: SYSDBA */
CREATE TABLE MATCH_GROUPE (SERMTC INTEGER NOT NULL,
        SERGRP INTEGER NOT NULL,
        SERCAT INTEGER NOT NULL,
        SERTRN INTEGER NOT NULL,
CONSTRAINT PK_MATCH_GROUPE PRIMARY KEY (SERMTC));

/* Table: PRPTAB, Owner: SYSDBA */
CREATE TABLE PRPTAB (SERPRP INTEGER NOT NULL,
        SERTAB INTEGER NOT NULL,
        SERTRN INTEGER NOT NULL,
        SERJOU INTEGER,
        SERPTN INTEGER,
        LICENCE VARCHAR(17),
        NOMJOU VARCHAR(40),
        CODCLB VARCHAR(8),
        LIBCLB VARCHAR(40),
        SEQCLS SMALLINT,
        CODCLS VARCHAR(7),
        CLASSEMENT VARCHAR(3),
        VRBRGL SMALLINT,
        NUMTDS SMALLINT,
        SERBLO INTEGER,
        SERGRP INTEGER,
        IS_QUALIFIED CHAR(1) DEFAULT '1' NOT NULL,
PRIMARY KEY (SERPRP));

/* Table: SAISON, Owner: SYSDBA */
CREATE TABLE SAISON (SAISON SMALLINT NOT NULL,
        LIBELLE VARCHAR(11) NOT NULL,
        ACTIVE CHAR(1) NOT NULL,
PRIMARY KEY (SAISON));

/* Table: SEEK_CONFIG, Owner: SYSDBA */
CREATE TABLE SEEK_CONFIG (ID INTEGER NOT NULL,
        DESCRIPTION VARCHAR(30) NOT NULL,
        SOURCE BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
        PARAMS BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
        RETURNING BLOB SUB_TYPE TEXT SEGMENT SIZE 80,
        FIELDNAME VARCHAR(40),
        SEEK_MODE INTEGER DEFAULT 0,
        SEEK_CODE VARCHAR(30),
CONSTRAINT PK_SEEK_CONFIG PRIMARY KEY (ID));

/* Table: TABLEAU, Owner: SYSDBA */
CREATE TABLE TABLEAU (SERTAB INTEGER NOT NULL,
        TAILLE SMALLINT NOT NULL,
        NBRJOU SMALLINT NOT NULL,
        NBRTDS SMALLINT NOT NULL,
        SERTRN INTEGER NOT NULL,
        NBRGRP SMALLINT DEFAULT 0 NOT NULL,
PRIMARY KEY (SERTAB));

/* Table: TABLO, Owner: SYSDBA */
CREATE TABLE TABLO (SERBLO INTEGER NOT NULL,
        SERTAB INTEGER NOT NULL,
        SERJOU INTEGER,
        LICENCE VARCHAR(17),
        NOMJOU VARCHAR(40),
        CODCLB VARCHAR(8),
        LIBCLB VARCHAR(40),
        CODCLS VARCHAR(7),
        VRBRGL SMALLINT,
        NUMTDS SMALLINT,
        NUMROW SMALLINT,
        SERTRN INTEGER NOT NULL,
PRIMARY KEY (SERBLO));

/* Table: TEMPTABLES, Owner: SYSDBA */
CREATE TABLE TEMPTABLES (TABLENAME VARCHAR(16) NOT NULL,
PRIMARY KEY (TABLENAME));

/* Table: TOURNOI, Owner: SYSDBA */
CREATE TABLE TOURNOI (SERTRN INTEGER NOT NULL,
        SAISON SMALLINT NOT NULL,
        DATTRN DATE NOT NULL,
        ORGANISATEUR VARCHAR(40) NOT NULL,
        LIBELLE VARCHAR(60) NOT NULL,
        MAXCAT SMALLINT NOT NULL,
        CODCLS CHAR(6),
        EXPCOL VARCHAR(8),
        NUMTBL SMALLINT default 10 NOT NULL,
        CODCLB VARCHAR(3) NOT NULL,
        FIRST_ROUND_MODE SMALLINT,
PRIMARY KEY (SERTRN));

/* Table: UMPIRES, Owner: SYSDBA */
CREATE TABLE UMPIRES (SERTRN INTEGER NOT NULL,
        NUMTBL SMALLINT NOT NULL,
        SERUMP INTEGER,
        UMPIRE VARCHAR(40),
        STATBL CHAR(1) NOT NULL,
        SERMTC INTEGER,
        PRVMTC INTEGER,
PRIMARY KEY (SERTRN, NUMTBL));

/*  Index definitions for all user tables */
CREATE INDEX I01_CATEGORIES ON CATEGORIES (SERTRN, NUMSEQ);
CREATE INDEX I01_CLASSEMENT ON CLASSEMENT (NUMSEQ);
CREATE UNIQUE INDEX I01_GROUPE_RESULT ON GROUPE_RESULT (SERGRP, SERJOU, SERADV);
CREATE INDEX I01_INSC ON INSC (SERCAT, SIMPLE, SERJOU, SERPTN);
CREATE UNIQUE INDEX I01_JOUEUR ON JOUEUR (LICENCE, SAISON);
CREATE INDEX I02_JOUEUR ON JOUEUR (NOMJOU);
CREATE INDEX I01_MATCH ON MATCH (SERTAB, LEVEL, NUMSEQ);
CREATE INDEX I02_MATCH ON MATCH (SERJO1);
CREATE INDEX I03_MATCH ON MATCH (SERJO2);
CREATE INDEX I04_MATCH ON MATCH (SERTAB, NUMMTC);
CREATE INDEX I01_PRPTAB ON PRPTAB (SERTAB, NUMTDS);
CREATE INDEX I02_PRPTAB ON PRPTAB (SERTAB, SERJOU);
CREATE INDEX I03_PRPTAB ON PRPTAB (SERTAB, CODCLS);
CREATE INDEX I04_PRPTAB ON PRPTAB (SERTAB, SEQCLS);
CREATE INDEX I01_TABLO ON TABLO (SERTAB, NUMTDS);
CREATE INDEX I02_TABLO ON TABLO (SERTAB, NUMROW);
CREATE INDEX I03_TABLO ON TABLO (SERTAB, CODCLS);
CREATE INDEX I04_TABLO ON TABLO (SERTAB, CODCLB);
CREATE INDEX I05_TABLO ON TABLO (SERTAB, SERJOU);
CREATE INDEX I01_TOURNOI ON TOURNOI (SAISON);
CREATE INDEX I02_TOURNOI ON TOURNOI (DATTRN);

ALTER TABLE COMPO_GROUPE ADD CONSTRAINT FK_COMPO_GROUPE_SERCAT FOREIGN KEY (SERCAT) REFERENCES CATEGORIES (SERCAT);

ALTER TABLE COMPO_GROUPE ADD CONSTRAINT FK_COMPO_GROUPE_SERTRN FOREIGN KEY (SERTRN) REFERENCES TOURNOI (SERTRN);

ALTER TABLE GROUPE ADD CONSTRAINT FK_GROUPE_SERCAT FOREIGN KEY (SERCAT) REFERENCES CATEGORIES (SERCAT);

ALTER TABLE GROUPE ADD CONSTRAINT FK_GROUPE_SERTRN FOREIGN KEY (SERTRN) REFERENCES TOURNOI (SERTRN);

ALTER TABLE MATCH_GROUPE ADD CONSTRAINT FK_MATCH_GROUPE_SERCAT FOREIGN KEY (SERCAT) REFERENCES CATEGORIES (SERCAT);

ALTER TABLE MATCH_GROUPE ADD CONSTRAINT FK_MATCH_GROUPE_SERMTC FOREIGN KEY (SERMTC) REFERENCES MATCH (SERMTC);

ALTER TABLE MATCH_GROUPE ADD CONSTRAINT FK_MATCH_GROUPE_SERTRN FOREIGN KEY (SERTRN) REFERENCES TOURNOI (SERTRN);

/* Table constraints */

ALTER TABLE GROUPE ADD 
        CONSTRAINT CHK_GROUPE_STAGRP CHECK(stagrp IN ('0','1','2','3','4'));

ALTER TABLE PRPTAB ADD 
        CHECK(UPPER(is_qualified) IN ('0','1'));

ALTER TABLE CATEGORIES ADD 
        CHECK (phase IN ('0','1'));
SET TERM ^ ;

/* Triggers only will work for SQL triggers */
CREATE TRIGGER TRG_GAME_01 FOR MATCH 
ACTIVE AFTER UPDATE POSITION 0 
AS BEGIN
   IF ((NEW.stamtc <> OLD.stamtc) AND (new.stamtc = 2)) THEN
     POST_EVENT 'game_is_over';
 END ^

CREATE TRIGGER BD_MATCH_GROUPE FOR MATCH 
ACTIVE BEFORE DELETE POSITION 0 
AS BEGIN    DELETE FROM match_groupe WHERE sermtc = OLD.sermtc;END ^


SET TERM ; ^
COMMIT WORK;

/* Grant permissions for this database */
GRANT  ON JOUEUR TO PUBLIC;
GRANT  ON TOURNOI TO PUBLIC;
GRANT USAGE ON SEQUENCE CATEGORIE TO PUBLIC;
GRANT USAGE ON SEQUENCE INSCRIPTION TO PUBLIC;
GRANT USAGE ON SEQUENCE JOUEUR TO PUBLIC;
GRANT USAGE ON SEQUENCE SEEK_GEN_ID TO PUBLIC;
GRANT USAGE ON SEQUENCE SEQ_1 TO PUBLIC;
GRANT USAGE ON SEQUENCE SEQ_2 TO PUBLIC;
GRANT USAGE ON SEQUENCE SEQ_SERGRP TO PUBLIC;
GRANT USAGE ON SEQUENCE TOURNOI TO PUBLIC;

/* Comments for database objects. */
COMMENT ON    COLUMN    TOURNOI.CODCLS IS 'codcls,topdem,topcls';


insert into classement (codcls,libcls,numseq,catage) values ('A1','A1',10,0);
insert into classement (codcls,libcls,numseq,catage) values ('A3','A3',14,0);
insert into classement (codcls,libcls,numseq,catage) values ('A2','A2',12,0);
insert into classement (codcls,libcls,numseq,catage) values ('B1','B1',20,0);
insert into classement (codcls,libcls,numseq,catage) values ('B2','B2',22,0);
insert into classement (codcls,libcls,numseq,catage) values ('B3','B3',24,0);
insert into classement (codcls,libcls,numseq,catage) values ('C1','C1',30,0);
insert into classement (codcls,libcls,numseq,catage) values ('C2','C2',32,0);
insert into classement (codcls,libcls,numseq,catage) values ('C3','C3',34,0);
insert into classement (codcls,libcls,numseq,catage) values ('D1','D1',40,0);
insert into classement (codcls,libcls,numseq,catage) values ('D2','D2',42,0);
insert into classement (codcls,libcls,numseq,catage) values ('D3','D3',44,0);
insert into classement (codcls,libcls,numseq,catage) values ('PM','Préminime',100,1);
insert into classement (codcls,libcls,numseq,catage) values ('M','Minime',102,1);
insert into classement (codcls,libcls,numseq,catage) values ('C','Cadet',104,1);
insert into classement (codcls,libcls,numseq,catage) values ('J','Juniors',106,1);
insert into classement (codcls,libcls,numseq,catage) values ('U21','U21',108,1);
insert into classement (codcls,libcls,numseq,catage) values ('S','Senior',110,1);
insert into classement (codcls,libcls,numseq,catage) values ('V','Vétéran',112,1);

insert into catage (catage,saison,inferieur,superieur) values ('PM' ,2018,2007,null);
insert into catage (catage,saison,inferieur,superieur) values ('M'  ,2018,2005,2006);
insert into catage (catage,saison,inferieur,superieur) values ('C'  ,2018,2003,2004);
insert into catage (catage,saison,inferieur,superieur) values ('J'  ,2018,2000,2002);
insert into catage (catage,saison,inferieur,superieur) values ('U21',2018,1997,1999);
insert into catage (catage,saison,inferieur,superieur) values ('S'  ,2018,1978,1996);
insert into catage (catage,saison,inferieur,superieur) values ('V'  ,2018,NULL,1977);

